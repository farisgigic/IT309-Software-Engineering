<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile</title>
  <link rel="stylesheet" href="css/datatables.min.css" type="text/css">
  <link rel="stylesheet" href="css/myprofile.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
  <div class="breadcrumb-option"
    style="background-image: url('img/breadcrumb-bg.jpg'); background-size: cover; background-position: center;">
    <div class="container">
      <div class="row">
        <div class="col-lg-12 text-center">
          <div class="breadcrumb__text">
            <h2>My Profile</h2>
            <div class="breadcrumb__links">
              <a href="#landing"><i class="fa fa-home" style="color: #0D9FF2;"></i> Home</a>
              <span>My Profile</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Section Begin -->
  <section class="profile">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="profile-card">
            <div class="row no-gutters">
              <!-- Profile Image -->
              <div class="col-lg-4">
                <div class="profile__image">
                  <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <h4 id="full_name">Loading...</h4>
                  <p id="email">Loading...</p>
                </div>
              </div>

              <!-- Profile Details -->
              <div class="col-lg-8">
                <div class="profile__details">
                  <h4>
                    <i class="fas fa-user-circle"></i>
                    Account Information
                  </h4>
                  <hr>

                  <div class="profile__info">
                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-user"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Full Name</div>
                        <div class="info-value" id="full_name_detail">Loading...</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-envelope"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Email Address</div>
                        <div class="info-value" id="email_detail">Loading...</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-at"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Username</div>
                        <div class="info-value" id="username">Loading...</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-birthday-cake"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Birth Date</div>
                        <div class="info-value" id="birth_date">Not specified</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-map-marker-alt"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Address</div>
                        <div class="info-value" id="address">Not specified</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-city"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">City</div>
                        <div class="info-value" id="city">Not specified</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-mail-bulk"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">ZIP Code</div>
                        <div class="info-value" id="zip_code">Not specified</div>
                      </div>
                    </div>

                    <div class="info-item">
                      <div class="info-icon">
                        <i class="fas fa-user-tag"></i>
                      </div>
                      <div class="info-content">
                        <div class="info-label">Role</div>
                        <div class="info-value" id="role">Loading...</div>
                      </div>
                    </div>
                  </div>

                  <div class="btn-group">
                    <button class="primary-btn" id="editProfileBtn">
                      <i class="fas fa-edit"></i>
                      Edit Profile
                    </button>
                    <a href="#logout" class="primary-btn logout-btn">
                      <i class="fas fa-sign-out-alt"></i>
                      Logout
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-user-edit"></i>
          Edit Profile
        </h2>
      </div>

      <form id="editUserForm">
        <input type="hidden" id="editUserId" name="id" />

        <div class="form-group">
          <label class="form-label">First Name</label>
          <input type="text" id="editFirstName" name="first_name" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">Last Name</label>
          <input type="text" id="editLastName" name="last_name" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" id="editEmail" name="email" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" id="editUsername" name="username" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label">City</label>
          <input type="text" id="editCity" name="city" class="form-input">
        </div>

        <div class="modal-actions">
          <button type="button" id="cancelEditBtn" class="btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </button>
          <button type="submit" class="primary-btn">
            <i class="fas fa-save"></i>
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Get the user data from localStorage
    const userData = JSON.parse(localStorage.getItem("user"));

    // If the data exists, populate the fields
    if (userData) {
      const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || 'No name provided';

      // Populate profile information
      document.getElementById("full_name").textContent = fullName;
      document.getElementById("full_name_detail").textContent = fullName;
      document.getElementById("email").textContent = userData.email || 'No email provided';
      document.getElementById("email_detail").textContent = userData.email || 'No email provided';
      document.getElementById("username").textContent = userData.username || 'No username';
      document.getElementById("birth_date").textContent = userData.birth_date || 'Not specified';
      document.getElementById("address").textContent = userData.address || 'Not specified';
      document.getElementById("city").textContent = userData.city || 'Not specified';
      document.getElementById("zip_code").textContent = userData.zip_code || 'Not specified';
      document.getElementById("role").textContent = userData.role || 'User';
    } else {
      // If no user data found, show error message
      document.querySelectorAll('[id$="_name"], [id$="_detail"], #email, #username, #role').forEach(el => {
        el.textContent = 'Please log in to view profile';
      });
    }

    // Modal functionality
    function openEditModal(user) {
      const modal = document.getElementById("editUserModal");
      modal.classList.add("show");

      document.getElementById("editUserId").value = user.id || '';
      document.getElementById("editFirstName").value = user.first_name || '';
      document.getElementById("editLastName").value = user.last_name || '';
      document.getElementById("editEmail").value = user.email || '';
      document.getElementById("editUsername").value = user.username || '';
      document.getElementById("editCity").value = user.city || '';
    }

    function closeEditModal() {
      const modal = document.getElementById("editUserModal");
      modal.classList.remove("show");
    }

    // Event listeners
    document.getElementById("editProfileBtn").addEventListener("click", function () {
      if (userData) {
        openEditModal(userData);
      } else {
        alert("Please log in to edit your profile.");
      }
    });

    document.getElementById("cancelEditBtn").addEventListener("click", closeEditModal);

    // Close modal when clicking outside
    document.getElementById("editUserModal").addEventListener("click", function (e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Form submission
    document.getElementById("editUserForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const id = document.getElementById("editUserId").value;
      console.log(id);
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Please log in to update your profile.");
        return;
      }

      const updatedUser = {
        first_name: document.getElementById("editFirstName").value.trim(),
        last_name: document.getElementById("editLastName").value.trim(),
        email: document.getElementById("editEmail").value.trim(),
        username: document.getElementById("editUsername").value.trim(),
        city: document.getElementById("editCity").value.trim()
      };

      // Show loading state
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      submitBtn.disabled = true;
      console.log("farecare", updatedUser);
      RestClient.put(`users/edit_user/${id}`, updatedUser, function (response) {
        // Update localStorage with new user data
        const updatedLocalUser = { ...userData, ...updatedUser };
        localStorage.setItem("user", JSON.stringify(updatedLocalUser));

        closeEditModal();
        location.reload();
      });
    });
  </script>
</body>

</html>